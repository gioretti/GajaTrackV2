@page "/daily-rhythm-map"
@inject IDailyRhythmMapService DailyRhythmMapService
@rendermode InteractiveAuto

<PageTitle>Daily Rhythm Map</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Daily Rhythm Map</h1>
    <div class="d-flex gap-2 align-items-center">
        <span>@_startDate.ToString("dd.MM.yyyy") - @_startDate.AddDays(13).ToString("dd.MM.yyyy")</span>
        <div class="btn-group">
            <button class="btn btn-outline-secondary" @onclick="PrevPage">&lt;</button>
            <button class="btn btn-outline-secondary" @onclick="NextPage">&gt;</button>
        </div>
    </div>
</div>

<div class="card p-3 shadow-sm overflow-auto">
    @if (_days == null)
    {
        <div class="d-flex justify-content-center p-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-center">
             <!-- The Chart contains the dates now -->
            <DailyRhythmMapChart Days="_days" VisibleTypes="_visibleTypes" />
        </div>
        
        <div class="mt-4 border-top pt-3">
            <h5>Legend</h5>
            <div class="d-flex gap-4 flex-wrap">
                <div class="d-flex align-items-center gap-2">
                    <input type="checkbox" checked="@_visibleTypes.Contains(DailyRhythmMapEventType.Sleep)" @onchange="@(() => ToggleVisibility(DailyRhythmMapEventType.Sleep))" class="form-check-input" />
                    <span style="display:inline-block; width:20px; height:6px; background:#333; border-radius:2px;"></span>
                    <span>Sleep</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <input type="checkbox" checked="@_visibleTypes.Contains(DailyRhythmMapEventType.Crying)" @onchange="@(() => ToggleVisibility(DailyRhythmMapEventType.Crying))" class="form-check-input" />
                    <svg width="24" height="20"><path d="M 0 10 C 2 5, 4 5, 6 10 C 8 15, 10 15, 12 10 C 14 5, 16 5, 18 10 C 20 15, 22 15, 24 10" stroke="black" stroke-width="1.5" fill="none"/></svg>
                    <span>Crying</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <input type="checkbox" checked="@_visibleTypes.Contains(DailyRhythmMapEventType.Nursing)" @onchange="@(() => ToggleVisibility(DailyRhythmMapEventType.Nursing))" class="form-check-input" />
                    <!-- CSS Triangle is hard with borders. Let's use SVG for legend too -->
                    <svg width="15" height="15"><polygon points="7.5,2 13,13 2,13" fill="white" stroke="black" stroke-width="2"/></svg>
                    <span>Nursing</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <input type="checkbox" checked="@_visibleTypes.Contains(DailyRhythmMapEventType.BottleFormula)" @onchange="@(() => ToggleVisibility(DailyRhythmMapEventType.BottleFormula))" class="form-check-input" />
                    <svg width="15" height="15"><polygon points="7.5,2 13,13 2,13" fill="blue" stroke="blue"/></svg>
                    <span>Formula</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <input type="checkbox" checked="@_visibleTypes.Contains(DailyRhythmMapEventType.BottleMilk)" @onchange="@(() => ToggleVisibility(DailyRhythmMapEventType.BottleMilk))" class="form-check-input" />
                    <svg width="15" height="15"><polygon points="7.5,2 13,13 2,13" fill="grey" stroke="grey"/></svg>
                    <span>Bottle (Milk)</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <input type="checkbox" checked="@_visibleTypes.Contains(DailyRhythmMapEventType.Diaper)" @onchange="@(() => ToggleVisibility(DailyRhythmMapEventType.Diaper))" class="form-check-input" />
                    <svg width="30" height="15">
                        <rect x="2" y="2" width="10" height="10" fill="#FFD700" />
                        <rect x="16" y="2" width="10" height="10" fill="#8B4513" />
                    </svg>
                    <span>Diaper (Yellow: Wet, Brown: Mixed/Solid)</span>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<DailyRhythmMapDay>? _days;
    // Default to showing the last 2 weeks ending today (or recent data)
    private DateOnly _startDate = DateOnly.FromDateTime(DateTime.UtcNow.AddDays(-13));
    
    private HashSet<DailyRhythmMapEventType> _visibleTypes = new()
    {
        DailyRhythmMapEventType.Sleep,
        DailyRhythmMapEventType.Crying,
        DailyRhythmMapEventType.Nursing,
        DailyRhythmMapEventType.BottleFormula,
        DailyRhythmMapEventType.BottleMilk,
        DailyRhythmMapEventType.Diaper
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private void ToggleVisibility(DailyRhythmMapEventType type)
    {
        if (_visibleTypes.Contains(type))
        {
            _visibleTypes.Remove(type);
        }
        else
        {
            _visibleTypes.Add(type);
        }
    }

    private async Task LoadData()
    {
        _days = await DailyRhythmMapService.GetDailyRhythmMapAsync(_startDate, _startDate.AddDays(13), mostRecentFirst: true);
    }
    
    private async Task PrevPage()
    {
        _startDate = _startDate.AddDays(-14);
        await LoadData();
    }

    private async Task NextPage()
    {
        _startDate = _startDate.AddDays(14);
        await LoadData();
    }
}
