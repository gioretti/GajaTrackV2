@using GajaTrack.Application.DTOs.Protocol
@using System.Text

<div class="protocol-chart-container">
    <svg viewBox="0 0 @TotalWidth @TotalHeight" preserveAspectRatio="xMidYMid meet" class="protocol-svg">
        <!-- Definitions for patterns/markers -->
        <defs>
            <clipPath id="chartClip">
                <rect x="@LeftMargin" y="0" width="@ChartWidth" height="@TotalHeight" />
            </clipPath>
        </defs>

        <!-- Background -->
        <rect x="0" y="0" width="@TotalWidth" height="@TotalHeight" fill="white" />

        <!-- Vertical Hour Grid Lines & Labels -->
        @for (int h = 0; h <= 24; h++)
        {
            var x = LeftMargin + (h * 60);
            var hour = (h + 6) % 24;
            var label = hour == 0 ? "24" : hour.ToString("00");
            if (h == 24) label = "06";
            
            var anchor = "middle";
            if (h == 0) anchor = "start";
            if (h == 24) anchor = "end";
            
            <!-- Grid Line -->
            <line x1="@x" y1="@HeaderHeight" x2="@x" y2="@TotalHeight" stroke="#e0e0e0" stroke-width="1" />
            
            <g>
                <text x="@x" y="@(HeaderHeight - 8)" font-size="12" text-anchor="@anchor" fill="#666">@label</text>
            </g>
        }

        <!-- Rows -->
        @for (int i = 0; i < Days.Count; i++)
        {
            var day = Days[i];
            var y = i * RowHeight + HeaderHeight;
            var midY = y + RowHeight / 2;
            
            <!-- Zebra Striping -->
            @if (i % 2 == 1)
            {
                <rect x="@LeftMargin" y="@y" width="@ChartWidth" height="@RowHeight" fill="#f8f9fa" opacity="0.5" />
            }
            
            <!-- Date Label (Left) -->
            <g>
                <text x="@(LeftMargin - 10)" y="@(midY + 4)" font-size="12" font-weight="bold" text-anchor="end" fill="#333">@day.Date.ToString("dd.MM.")</text>
            </g>

            <!-- Events -->
            <!-- We assume events are clipped to the day window by the service logic. -->
            @foreach (var ev in day.Events)
            {
                var xStart = LeftMargin + ev.StartMinute;
                var width = ev.DurationMinutes;
                
                switch (ev.Type)
                {
                    case ProtocolEventType.Sleep:
                        <!-- Sleep Line (Thin horizontal line) -->
                        <line x1="@xStart" y1="@midY" x2="@(xStart + width)" y2="@midY" stroke="black" stroke-width="3" stroke-linecap="round" title="Sleep: @ev.OriginalStartTime.ToString("HH:mm")" />
                        break;
                        
                    case ProtocolEventType.Crying:
                        <!-- Wavy Line (Black Sine Wave) -->
                        <path d="@GenerateSineWave(xStart, width, midY, 4)" stroke="black" stroke-width="1.5" fill="none" title="Crying: @ev.OriginalStartTime.ToString("HH:mm")" />
                        break;

                    case ProtocolEventType.Nursing:
                        <!-- Hollow Triangle -->
                        <polygon points="@GetTrianglePoints(xStart, midY)" fill="white" stroke="black" stroke-width="1.5" title="Nursing: @ev.OriginalStartTime.ToString("HH:mm")" />
                        break;
                        
                    case ProtocolEventType.BottleFormula:
                        <!-- Solid Blue Triangle -->
                        <polygon points="@GetTrianglePoints(xStart, midY)" fill="blue" stroke="blue" stroke-width="1" title="Formula: @ev.Description" />
                        break;
                        
                    case ProtocolEventType.BottleMilk:
                        <!-- Solid Grey Triangle -->
                        <polygon points="@GetTrianglePoints(xStart, midY)" fill="grey" stroke="grey" stroke-width="1" title="Bottle: @ev.Description" />
                        break;
                }
            }
        }
    </svg>
</div>

@code {
    [Parameter] public List<ProtocolDay> Days { get; set; } = new();
    
    private const double ChartWidth = 1440; // 24 hours * 60 minutes
    private const double LeftMargin = 60;   // Space for Date labels
    private const double TotalWidth = LeftMargin + ChartWidth + 20; // +Padding Right
    
    private const double RowHeight = 50;
    private const double HeaderHeight = 30;
    
    private double TotalHeight => Math.Max(RowHeight, Days.Count * RowHeight + HeaderHeight);

    private string GenerateSineWave(double startX, double width, double midY, double amplitude)
    {
        // Smooth sine wave
        var sb = new StringBuilder();
        sb.Append($"M {startX} {midY}");
        
        double frequency = 0.2; // Adjust for wave tightness
        int step = 2; // Pixel step for smoothness
        
        for (double x = 0; x <= width; x += step)
        {
             double yOffset = amplitude * Math.Sin((x) * frequency);
             sb.Append($" L {startX + x} {midY + yOffset}");
        }
        
        // Ensure we land at the end
        sb.Append($" L {startX + width} {midY + amplitude * Math.Sin(width * frequency)}");

        return sb.ToString();
    }
    
    private string GetTrianglePoints(double cx, double cy)
    {
        double size = 10;
        double halfSize = size / 2;
        // Pointing Up? Or Down?
        // Standard triangles in charts usually point up.
        // cx,cy is center of row.
        // Let's center the triangle vertically.
        
        // Top
        double x1 = cx;
        double y1 = cy - halfSize;
        
        // Bottom Right
        double x2 = cx + halfSize;
        double y2 = cy + halfSize;
        
        // Bottom Left
        double x3 = cx - halfSize;
        double y3 = cy + halfSize;
        
        return $"{x1},{y1} {x2},{y2} {x3},{y3}";
    }
}