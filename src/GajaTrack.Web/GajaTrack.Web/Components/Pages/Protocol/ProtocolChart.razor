@using GajaTrack.Application.DTOs.Protocol
@using System.Text

<div class="protocol-chart-container">
    <svg viewBox="0 0 @TotalWidth @TotalHeight" preserveAspectRatio="xMidYMid meet" class="protocol-svg">
        <!-- Definitions for patterns/markers -->
        <defs>
            <clipPath id="chartClip">
                <rect x="@LeftMargin" y="0" width="@ChartWidth" height="@TotalHeight" />
            </clipPath>
        </defs>

        <!-- Background -->
        <rect x="0" y="0" width="@TotalWidth" height="@TotalHeight" fill="white" />
        
        <!-- Column Banding (Vertical Striping) -->
        @for (int h = 0; h < 24; h++)
        {
            if (h % 2 == 0) // Alternating hours
            {
                var x = LeftMargin + (h * 60);
                <rect x="@x" y="@HeaderHeight" width="60" height="@(TotalHeight - HeaderHeight)" fill="#f9f9f9" />
            }
        }

        <!-- Vertical Hour Grid Lines & Labels -->
        @for (int h = 0; h <= 24; h++)
        {
            var x = LeftMargin + (h * 60);
            var hour = (h + 6) % 24;
            var label = hour == 0 ? "24" : hour.ToString("00");
            if (h == 24) label = "06";
            
            var anchor = "middle";
            if (h == 0) anchor = "start";
            if (h == 24) anchor = "end";
            
            <!-- Grid Line -->
            <line x1="@x" y1="@HeaderHeight" x2="@x" y2="@TotalHeight" stroke="#e0e0e0" stroke-width="1" />
            
            <g>
                <text x="@x" y="@(HeaderHeight - 8)" font-size="12" text-anchor="@anchor" fill="#666">@label</text>
            </g>
        }
        
        <!-- Summary Header -->
        <g>
            <text x="@(LeftMargin + ChartWidth + 10)" y="@(HeaderHeight - 8)" font-size="12" font-weight="bold" text-anchor="start" fill="#333">Summary</text>
        </g>

        <!-- Rows -->
        @for (int i = 0; i < Days.Count; i++)
        {
            var day = Days[i];
            var y = i * RowHeight + HeaderHeight;
            var midY = y + RowHeight / 2;
            
            <!-- Row Banding (Zebra Striping) - Darker to contrast with columns -->
            @if (i % 2 == 1)
            {
                <!-- Use a mix-blend-mode or just simple transparency overlay -->
                <rect x="@LeftMargin" y="@y" width="@(ChartWidth + SummaryWidth)" height="@RowHeight" fill="#eef2f5" opacity="0.6" />
            }
            
            <!-- Date Label (Left) -->
            <g>
                <text x="@(LeftMargin - 10)" y="@(midY - 4)" font-size="10" font-weight="normal" text-anchor="end" fill="#999">@day.Date.ToString("ddd")</text>
                <text x="@(LeftMargin - 10)" y="@(midY + 10)" font-size="12" font-weight="bold" text-anchor="end" fill="#333">@day.Date.ToString("dd.MM.")</text>
            </g>
            
            <!-- Summary Data (Right) -->
            <g transform="translate(@(LeftMargin + ChartWidth + 10), @y)">
                <!-- Summary container for extensibility (starts at y+15 to allow room for header-like spacing) -->
                @{
                    var hours = (int)(day.Summary.TotalSleepMinutes / 60);
                    var minutes = (int)(day.Summary.TotalSleepMinutes % 60);
                }
                <text x="0" y="20" font-size="12" fill="#333" font-weight="500">Sleep: @(hours)h @(minutes)m</text>
                <!-- Space for future rows below (e.g., y=35, y=50...) -->
            </g>

            <!-- Events -->
            @foreach (var ev in day.Events)
            {
                var xStart = LeftMargin + ev.StartMinute;
                var width = ev.DurationMinutes;
                
                switch (ev.Type)
                {
                    case ProtocolEventType.Sleep:
                        <!-- Sleep Line (Thin horizontal line) -->
                        <line x1="@xStart" y1="@midY" x2="@(xStart + width)" y2="@midY" stroke="black" stroke-width="2" stroke-linecap="square" title="Sleep: @ev.OriginalStartTime.ToString("HH:mm")" />
                        break;
                        
                    case ProtocolEventType.Crying:
                        <!-- Wavy Line (Black Sine Wave) -->
                        <!-- Amplitude: 5px (Total height 10px, matches triangle) -->
                        <path d="@GenerateSineWave(xStart, width, midY, 5)" stroke="black" stroke-width="1.5" fill="none" title="Crying: @ev.OriginalStartTime.ToString("HH:mm")" />
                        break;

                    case ProtocolEventType.Nursing:
                        <!-- Hollow Triangle -->
                        <polygon points="@GetTrianglePoints(xStart, midY)" fill="white" stroke="black" stroke-width="1.5" title="Nursing: @ev.OriginalStartTime.ToString("HH:mm")" />
                        break;
                        
                    case ProtocolEventType.BottleFormula:
                        <!-- Solid Blue Triangle -->
                        <polygon points="@GetTrianglePoints(xStart, midY)" fill="blue" stroke="blue" stroke-width="1" title="Formula: @ev.OriginalStartTime.ToString("HH:mm") @ev.Description" />
                        break;
                        
                    case ProtocolEventType.BottleMilk:
                        <!-- Solid Grey Triangle -->
                        <polygon points="@GetTrianglePoints(xStart, midY)" fill="grey" stroke="grey" stroke-width="1" title="Bottle: @ev.OriginalStartTime.ToString("HH:mm") @ev.Description" />
                        break;
                }
            }
        }
    </svg>
</div>

@code {
    [Parameter] public List<ProtocolDay> Days { get; set; } = new();
    
    private const double ChartWidth = 1440; // 24 hours * 60 minutes
    private const double LeftMargin = 60;   // Space for Date labels
    private const double SummaryWidth = 120; // Space for Summary column
    private const double TotalWidth = LeftMargin + ChartWidth + SummaryWidth + 20; // +Padding Right
    
    private const double RowHeight = 50;
    private const double HeaderHeight = 30;
    
    private double TotalHeight => Math.Max(RowHeight, Days.Count * RowHeight + HeaderHeight);

    private string GenerateSineWave(double startX, double width, double midY, double amplitude)
    {
        var sb = new StringBuilder();
        sb.Append($"M {startX} {midY}");
        
        // Tighter wave: Wavelength = 6px (Frequency ~ 1.0)
        double frequency = 1.0; 
        int step = 1; 
        
        for (double x = 0; x <= width; x += step)
        {
             // Use Math.Sin with a tighter period
             double yOffset = amplitude * Math.Sin(x * frequency);
             sb.Append($" L {startX + x} {midY + yOffset}");
        }
        
        return sb.ToString();
    }
    
    private string GetTrianglePoints(double cx, double cy)
    {
        double size = 10;
        double halfSize = size / 2;
        // Pointing Up? Or Down?
        // Standard triangles in charts usually point up.
        // cx,cy is center of row.
        // Let's center the triangle vertically.
        
        // Top
        double x1 = cx;
        double y1 = cy - halfSize;
        
        // Bottom Right
        double x2 = cx + halfSize;
        double y2 = cy + halfSize;
        
        // Bottom Left
        double x3 = cx - halfSize;
        double y3 = cy + halfSize;
        
        return $"{x1},{y1} {x2},{y2} {x3},{y3}";
    }
}