@page "/"
@using GajaTrack.Application.Interfaces
@using GajaTrack.Infrastructure.Persistence
@using Microsoft.EntityFrameworkCore
@inject GajaDbContext DbContext
@inject IExportService ExportService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Baby Gaja Tracking</h1>
    <button class="btn btn-secondary" @onclick="DownloadExport">
        <i class="bi bi-download"></i> Export Data
    </button>
</div>

<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-center p-3">
            <h3>Nursing</h3>
            <p class="display-4">@_nursingCount</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center p-3">
            <h3>Bottle</h3>
            <p class="display-4">@_bottleCount</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center p-3">
            <h3>Sleep</h3>
            <p class="display-4">@_sleepCount</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center p-3">
            <h3>Diapers</h3>
            <p class="display-4">@_diaperCount</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center p-3">
            <h3>Crying</h3>
            <p class="display-4">@_cryingCount</p>
        </div>
    </div>
</div>

@code {
    private int _nursingCount;
    private int _bottleCount;
    private int _sleepCount;
    private int _diaperCount;
    private int _cryingCount;

    protected override async Task OnInitializedAsync()
    {
        _nursingCount = await DbContext.NursingFeeds.CountAsync();
        _bottleCount = await DbContext.BottleFeeds.CountAsync();
        _sleepCount = await DbContext.SleepSessions.CountAsync();
        _diaperCount = await DbContext.DiaperChanges.CountAsync();
        _cryingCount = await DbContext.CryingSessions.CountAsync();
    }

    private async Task DownloadExport()
    {
        var bytes = await ExportService.ExportDataAsync();
        var fileName = $"gajatrack_export_{DateTime.UtcNow:yyyy-MM-dd}.json";
        
        using var stream = new MemoryStream(bytes);
        using var streamRef = new DotNetStreamReference(stream);
        
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }
}
