@page "/import-babyplus"
@using GajaTrack.Application.Interfaces
@inject IServiceScopeFactory ScopeFactory
@inject ILogger<BabyPlusImport> Logger
@rendermode InteractiveServer

<PageTitle>Import Baby+ Data</PageTitle>

<h1>Import Data</h1>
<p>Upload your export file from Philips Baby+ (iOS or Android).</p>

<div class="card p-4 shadow-sm" style="max-width: 600px;">
    <div class="mb-3">
        <label for="fileInput" class="form-label">Select JSON file</label>
        <InputFile OnChange="HandleFileSelected" class="form-control" id="fileInput" accept=".json" />
    </div>

    <button class="btn btn-primary mb-3" @onclick="TriggerImport" disabled="@_isProcessing">
        @if (_isProcessing)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span> Importing...</span>
        }
        else
        {
            <span>Import Data</span>
        }
    </button>
    
    @if (_isProcessing)
    {
        <div class="alert alert-info shadow-sm">
            <p class="mb-1"><strong>Processing...</strong> please wait.</p>
            <small class="text-muted">@_progressMessage</small>
        </div>
    }
    
    @if (_errorMessage != null)
    {
        <div class="alert alert-danger shadow-sm">
            <p class="mb-0">@_errorMessage</p>
        </div>
    }

    @if (_summary != null)
    {
        <div class="alert alert-success shadow-sm">
            <h4 class="alert-heading">ðŸŽ‰ Import Complete!</h4>
            <hr>
            <ul>
                <li>Nursing: <strong>@_summary.NursingFeedsImported</strong></li>
                <li>Bottle: <strong>@_summary.BottleFeedsImported</strong></li>
                <li>Sleep: <strong>@_summary.SleepSessionsImported</strong></li>
                <li>Diapers: <strong>@_summary.DiaperChangesImported</strong></li>
                <li>Crying: <strong>@_summary.CryingSessionsImported</strong></li>
            </ul>
            <a href="/" class="btn btn-outline-success btn-sm">View Dashboard</a>
        </div>
    }
</div>

@code {
    private IBrowserFile? _selectedFile;
    private ImportSummary? _summary;
    private string? _errorMessage;
    private string? _progressMessage;
    private bool _isProcessing;
    
    private const long MaxFileSize = 10 * 1024 * 1024; 

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _errorMessage = null;
        _summary = null;
        StateHasChanged();
    }

    private async Task TriggerImport()
    {
        if (_selectedFile == null)
        {
            _errorMessage = "Please select a file first.";
            return;
        }

        _isProcessing = true;
        _errorMessage = null;
        _summary = null;
        _progressMessage = "Initializing...";
        StateHasChanged();

        try
        {
            if (_selectedFile.Size > MaxFileSize)
            {
                _errorMessage = $"File exceeds 10MB.";
                return;
            }

            var progressReporter = new Progress<string>(m => 
            {
                _progressMessage = m;
                InvokeAsync(StateHasChanged);
            });

            using var ms = new MemoryStream();
            await _selectedFile.OpenReadStream(MaxFileSize).CopyToAsync(ms);
            ms.Position = 0;

            _progressMessage = "Upload complete. Starting background processing...";
            StateHasChanged();

            // Offload to background thread with a FRESH scope to avoid DbContext threading issues
            _summary = await Task.Run(async () => 
            {
                using var scope = ScopeFactory.CreateScope();
                var scopedService = scope.ServiceProvider.GetRequiredService<IBabyPlusImportService>();
                return await scopedService.ImportFromStreamAsync(ms, progressReporter);
            });

            Logger.LogInformation("Imported records successfully.");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Import failed");
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }
}