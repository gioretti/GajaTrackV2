@using GajaTrack.Application.DTOs.DailyRhythmMap
@using System.Text

<div class="sleep-correlation-chart-container mt-4 card p-3 shadow-sm">
    <h5 class="mb-3">Nap Duration vs. Night Wakings (Correlation)</h5>
    <svg viewBox="0 0 @TotalWidth @TotalHeight" preserveAspectRatio="xMidYMid meet" class="sleep-correlation-svg">
        <!-- Background -->
        <rect x="0" y="0" width="@TotalWidth" height="@TotalHeight" fill="white" />

        <!-- X-Axis Labels & Vertical Grid Lines (0 to 12h Naps) -->
        @for (int h = 0; h <= MaxNapHours; h++)
        {
            var x = LeftMargin + (h * XScale);
            <line x1="@x" y1="@TopMargin" x2="@x" y2="@(TotalHeight - BottomMargin)" stroke="#eee" stroke-width="1" />
            <svg:text x="@x" y="@(TotalHeight - 10)" font-size="10" text-anchor="middle" fill="#666">@(h)h</svg:text>
        }
        <svg:text x="@(LeftMargin + ChartWidth / 2)" y="@(TotalHeight - 2)" font-size="11" text-anchor="middle" font-weight="bold" fill="#333">Daytime Nap Duration (Hours)</svg:text>

        <!-- Y-Axis Labels & Horizontal Grid Lines (0 to Max Wakings) -->
        @{
            var filteredData = Days.Select(d => new { 
                Day = d, 
                WakingCount = GetFilteredNightWakingCount(d) 
            }).ToList();

            var maxWakings = filteredData.Count > 0 ? Math.Max(5, filteredData.Max(d => d.WakingCount)) : 5;
            var yScale = ChartHeight / (double)maxWakings;
        }
        @for (int w = 0; w <= maxWakings; w++)
        {
            var y = (TotalHeight - BottomMargin) - (w * yScale);
            <line x1="@LeftMargin" y1="@y" x2="@(TotalWidth - RightMargin)" y2="@y" stroke="#eee" stroke-width="1" />
            <svg:text x="@(LeftMargin - 10)" y="@(y + 4)" font-size="10" text-anchor="end" fill="#666">@w</svg:text>
        }
        <svg:text transform="rotate(-90, 15, @(TopMargin + ChartHeight / 2))" x="15" y="@(TopMargin + ChartHeight / 2)" font-size="11" text-anchor="middle" font-weight="bold" fill="#333">Night Wakings (Filtered)</svg:text>

        <!-- Data Points (Circles) -->
        @foreach (var item in filteredData)
        {
            var xPos = LeftMargin + (item.Day.Summary.NapsMinutes / 60.0) * XScale;
            var yPos = (TotalHeight - BottomMargin) - (item.WakingCount * yScale);

            <circle cx="@xPos" cy="@yPos" r="5" fill="#1a237e" opacity="0.5">
                <title>@item.Day.Date: Naps @FormatMinutes(item.Day.Summary.NapsMinutes), Filtered Wakings: @item.WakingCount</title>
            </circle>
        }
    </svg>
</div>

@code {
    [Parameter] public List<DailyRhythmMapDay> Days { get; set; } = new();

    private const double TotalWidth = 1600;
    private const double TotalHeight = 350;
    private const double TopMargin = 20;
    private const double BottomMargin = 50;
    private const double LeftMargin = 60;
    private const double RightMargin = 40;

    private const int MaxNapHours = 12;
    private const double ChartWidth = TotalWidth - LeftMargin - RightMargin;
    private const double ChartHeight = TotalHeight - TopMargin - BottomMargin;
    private const double XScale = ChartWidth / (double)MaxNapHours;

    private int GetFilteredNightWakingCount(DailyRhythmMapDay day)
    {
        // Filter for sleep events starting after 18:00 (720 min) with duration >= 20m
        var nightSessions = day.Events
            .Where(e => e.Type == DailyRhythmMapEventType.Sleep && e.StartMinute >= 720 && e.DurationMinutes >= 20)
            .ToList();

        // Waking count is N - 1 (interruptions), minimum 0.
        return Math.Max(0, nightSessions.Count - 1);
    }

    private string FormatMinutes(double totalMinutes)
    {
        var h = (int)(totalMinutes / 60);
        var m = (int)(totalMinutes % 60);
        return $"{h}h {m}m";
    }
}
