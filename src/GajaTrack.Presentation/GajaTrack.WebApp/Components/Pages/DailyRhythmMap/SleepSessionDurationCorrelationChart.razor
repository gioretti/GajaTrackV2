@using GajaTrack.Application.DTOs.DailyRhythmMap
@using System.Text

<div class="sleep-session-duration-correlation-chart-container mt-4 card p-3 shadow-sm">
    <h5 class="mb-3">Nap Duration vs. Avg Night Session Length (Correlation)</h5>
    <svg viewBox="0 0 @TotalWidth @TotalHeight" preserveAspectRatio="xMidYMid meet" class="sleep-correlation-svg">
        <!-- Background -->
        <rect x="0" y="0" width="@TotalWidth" height="@TotalHeight" fill="white" />

        <!-- X-Axis Labels & Vertical Grid Lines (0 to 12h Naps) -->
        @for (int h = 0; h <= MaxNapHours; h++)
        {
            var x = LeftMargin + (h * XScale);
            <line x1="@x" y1="@TopMargin" x2="@x" y2="@(TotalHeight - BottomMargin)" stroke="#eee" stroke-width="1" />
            <svg:text x="@x" y="@(TotalHeight - 10)" font-size="10" text-anchor="middle" fill="#666">@(h)h</svg:text>
        }
        <svg:text x="@(LeftMargin + ChartWidth / 2)" y="@(TotalHeight - 2)" font-size="11" text-anchor="middle" font-weight="bold" fill="#333">Daytime Nap Duration (Hours)</svg:text>

        <!-- Y-Axis Labels & Horizontal Grid Lines (0 to Max Hours) -->
        @{
            var validDays = Days.Select(d => new { 
                Day = d, 
                AvgNightSession = GetAverageFilteredNightSessionMinutes(d) 
            }).Where(x => x.AvgNightSession > 0).ToList();

            var maxAvgHours = validDays.Count > 0 ? Math.Max(6, (int)Math.Ceiling(validDays.Max(x => x.AvgNightSession) / 60.0)) : 6;
            var yScale = ChartHeight / (double)maxAvgHours;
        }
        @for (int h = 0; h <= maxAvgHours; h++)
        {
            var y = (TotalHeight - BottomMargin) - (h * 60.0 / 60.0 * yScale);
            <line x1="@LeftMargin" y1="@y" x2="@(TotalWidth - RightMargin)" y2="@y" stroke="#eee" stroke-width="1" />
            <svg:text x="@(LeftMargin - 10)" y="@(y + 4)" font-size="10" text-anchor="end" fill="#666">@(h)h</svg:text>
        }
        <svg:text transform="rotate(-90, 15, @(TopMargin + ChartHeight / 2))" x="15" y="@(TopMargin + ChartHeight / 2)" font-size="11" text-anchor="middle" font-weight="bold" fill="#333">Avg Filtered Night Session</svg:text>

        <!-- Data Points (Circles) -->
        @foreach (var item in validDays)
        {
            var xPos = LeftMargin + (item.Day.Summary.NapsMinutes / 60.0) * XScale;
            var yPos = (TotalHeight - BottomMargin) - (item.AvgNightSession / 60.0) * yScale;

            <circle cx="@xPos" cy="@yPos" r="5" fill="#ffb300" opacity="0.5">
                <title>@item.Day.Date: Naps @FormatMinutes(item.Day.Summary.NapsMinutes), Avg Filtered Session: @FormatMinutes(item.AvgNightSession)</title>
            </circle>
        }
    </svg>
</div>

@code {
    [Parameter] public List<DailyRhythmMapDay> Days { get; set; } = new();

    private const double TotalWidth = 1600;
    private const double TotalHeight = 350;
    private const double TopMargin = 20;
    private const double BottomMargin = 50;
    private const double LeftMargin = 60;
    private const double RightMargin = 40;

    private const int MaxNapHours = 12;
    private const double ChartWidth = TotalWidth - LeftMargin - RightMargin;
    private const double ChartHeight = TotalHeight - TopMargin - BottomMargin;
    private const double XScale = ChartWidth / (double)MaxNapHours;

    private double GetAverageFilteredNightSessionMinutes(DailyRhythmMapDay day)
    {
        // Filter sleep events starting after 18:00 (720 min) with duration >= 20m
        var nightSessions = day.Events
            .Where(e => e.Type == DailyRhythmMapEventType.Sleep && e.StartMinute >= 720 && e.DurationMinutes >= 20)
            .ToList();

        if (nightSessions.Count == 0) return 0;

        return nightSessions.Average(s => s.DurationMinutes);
    }

    private string FormatMinutes(double totalMinutes)
    {
        var h = (int)(totalMinutes / 60);
        var m = (int)(totalMinutes % 60);
        return $"{h}h {m}m";
    }
}
