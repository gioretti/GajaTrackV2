@page "/sleep-trends"
@using GajaTrack.Application.DTOs.DailyRhythmMap
@using GajaTrack.WebApp.Api
@inject DailyRhythmMapApiClient DailyRhythmMapApi

<PageTitle>Sleep Trends</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Sleep Duration Trends</h1>
    <div class="d-flex gap-2 align-items-center">
        <div class="d-flex align-items-center gap-2">
            <input type="date" @bind="_startDate" @bind:after="LoadData" class="form-control" />
            <span>-</span>
            <input type="date" @bind="_endDate" @bind:after="LoadData" class="form-control" />
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-secondary" @onclick="PrevPage">&lt;</button>
            <button class="btn btn-outline-secondary" @onclick="NextPage">&gt;</button>
        </div>
    </div>
</div>

@if (_days == null)
{
    <div class="d-flex justify-content-center p-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="d-flex flex-column align-items-center gap-2">
        <SleepTrendChart Days="_days" />
        <SleepDurationLineChart Days="_days" />
        <SleepCorrelationChart Days="_days" />
        <SleepSessionDurationCorrelationChart Days="_days" />
    </div>
}

@code {
    private List<DailyRhythmMapDay>? _days;
    private DateOnly _endDate = DateOnly.FromDateTime(DateTime.UtcNow);
    private DateOnly _startDate = DateOnly.FromDateTime(DateTime.UtcNow.AddDays(-29));

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        if (_startDate > _endDate)
        {
             // Auto-correct if start is after end? or just swap?
             // For now, let's just swap them to be safe, or do nothing and let the API handle empty list?
             // Swapping seems user friendly.
             (_startDate, _endDate) = (_endDate, _startDate);
        }

        _days = await DailyRhythmMapApi.GetAsync(_startDate, _endDate, mostRecentFirst: true);
    }

    private async Task PrevPage()
    {
        var diff = _endDate.DayNumber - _startDate.DayNumber + 1;
        _startDate = _startDate.AddDays(-diff);
        _endDate = _endDate.AddDays(-diff);
        await LoadData();
    }

    private async Task NextPage()
    {
        var diff = _endDate.DayNumber - _startDate.DayNumber + 1;
        _startDate = _startDate.AddDays(diff);
        _endDate = _endDate.AddDays(diff);
        await LoadData();
    }
}
