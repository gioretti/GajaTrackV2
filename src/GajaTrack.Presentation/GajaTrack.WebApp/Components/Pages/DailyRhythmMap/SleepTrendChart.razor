@using GajaTrack.Application.DTOs.DailyRhythmMap
@using System.Text

<div class="sleep-trend-chart-container mt-4 card p-3 shadow-sm">
    <h5 class="mb-3">Sleep Duration Trend (Last 30 Days)</h5>
    <svg viewBox="0 0 @TotalWidth @TotalHeight" preserveAspectRatio="xMidYMid meet" class="sleep-trend-svg">
        <!-- Background -->
        <rect x="0" y="0" width="@TotalWidth" height="@TotalHeight" fill="white" />

        <!-- Y-Axis Grid Lines & Labels (0 to 24h) -->
        @for (int h = 0; h <= 24; h += 6)
        {
            var y = ChartHeight - (h * HourScale) + TopMargin;
            <line x1="@LeftMargin" y1="@y" x2="@(TotalWidth - RightMargin)" y2="@y" stroke="#e0e0e0" stroke-width="1" />
            <g>
                <text x="@(LeftMargin - 10)" y="@(y + 4)" font-size="12" text-anchor="end" fill="#666">@(h)h</text>
            </g>
        }

        @{
            var sortedDays = Days.OrderBy(d => d.Date).ToList();
            var bottomY = ChartHeight + TopMargin;
            var xStep = (TotalWidth - LeftMargin - RightMargin) / Math.Max(1, sortedDays.Count - 1);
        }

        @if (sortedDays.Count > 0)
        {
            <!-- 1. Total Sleep Area (Night + Naps) - Background Layer -->
            <path d="@GenerateAreaPath(sortedDays, xStep, bottomY, true)" fill="#ffb300" opacity="0.8" />
            
            <!-- 2. Night Sleep Area - Foreground Layer -->
            <path d="@GenerateAreaPath(sortedDays, xStep, bottomY, false)" fill="#1a237e" opacity="0.9" />

            <!-- Vertical lines and Date labels for each day -->
            @for (int i = 0; i < sortedDays.Count; i++)
            {
                var day = sortedDays[i];
                var x = LeftMargin + (i * xStep);
                
                <!-- Subtle vertical guide -->
                <line x1="@x" y1="@TopMargin" x2="@x" y2="@bottomY" stroke="#eee" stroke-width="1" stroke-dasharray="2,2" />

                <!-- Date Label (every 3rd day to avoid crowding) -->
                @if (i % 3 == 0 || i == sortedDays.Count - 1)
                {
                    <g>
                        <text x="@x" y="@(TotalHeight - 5)" font-size="10" text-anchor="middle" fill="#999">@day.Date.ToString("dd.MM")</text>
                    </g>
                }
                
                <!-- Tooltip Trigger (Invisible circle for hover) -->
                <circle cx="@x" cy="@(GetTotalY(day))" r="10" fill="transparent">
                    <title>@day.Date: Night @FormatMinutes(day.Summary.NightSleepMinutes), Naps @FormatMinutes(day.Summary.NapsMinutes)</title>
                </circle>
            }
        }

        <!-- Legend -->
        <g transform="translate(@(TotalWidth - 150), 10)">
            <rect x="0" y="0" width="12" height="12" fill="#ffb300" />
            <text x="18" y="10" font-size="12" fill="#333">Naps</text>
            <rect x="0" y="20" width="12" height="12" fill="#1a237e" />
            <text x="18" y="30" font-size="12" fill="#333">Night</text>
        </g>
    </svg>
</div>

@code {
    [Parameter] public List<DailyRhythmMapDay> Days { get; set; } = new();

    private const double TotalWidth = 1400;
    private const double TotalHeight = 350;
    private const double TopMargin = 40;
    private const double BottomMargin = 30;
    private const double LeftMargin = 50;
    private const double RightMargin = 50;

    private const double ChartHeight = TotalHeight - TopMargin - BottomMargin;
    private const double HourScale = ChartHeight / 24.0;

    private string GenerateAreaPath(List<DailyRhythmMapDay> sortedDays, double xStep, double bottomY, bool includeNaps)
    {
        if (sortedDays.Count == 0) return "";

        var sb = new StringBuilder();
        
        // Start at the bottom-left corner
        sb.Append($"M {LeftMargin} {bottomY}");

        // Trace the top line
        for (int i = 0; i < sortedDays.Count; i++)
        {
            var day = sortedDays[i];
            var x = LeftMargin + (i * xStep);
            var minutes = includeNaps 
                ? day.Summary.NightSleepMinutes + day.Summary.NapsMinutes 
                : day.Summary.NightSleepMinutes;
            
            var y = ChartHeight - (minutes / 60.0) * HourScale + TopMargin;
            sb.Append($" L {x} {y}");
        }

        // Close the shape by going to the bottom-right and back to start
        sb.Append($" L {LeftMargin + (sortedDays.Count - 1) * xStep} {bottomY} Z");

        return sb.ToString();
    }

    private double GetTotalY(DailyRhythmMapDay day)
    {
        var totalMinutes = day.Summary.NightSleepMinutes + day.Summary.NapsMinutes;
        return ChartHeight - (totalMinutes / 60.0) * HourScale + TopMargin;
    }

    private string FormatMinutes(double totalMinutes)
    {
        var h = (int)(totalMinutes / 60);
        var m = (int)(totalMinutes % 60);
        return $"{h}h {m}m";
    }
}
