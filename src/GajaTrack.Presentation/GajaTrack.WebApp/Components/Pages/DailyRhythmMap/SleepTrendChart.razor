@using GajaTrack.Application.DTOs.DailyRhythmMap

<div class="sleep-trend-chart-container mt-4 card p-3 shadow-sm">
    <h5 class="mb-3">Sleep Duration Trend (Last 14 Days)</h5>
    <svg viewBox="0 0 @TotalWidth @TotalHeight" preserveAspectRatio="xMidYMid meet" class="sleep-trend-svg">
        <!-- Background -->
        <rect x="0" y="0" width="@TotalWidth" height="@TotalHeight" fill="white" />

        <!-- Y-Axis Grid Lines & Labels (0 to 24h) -->
        @for (int h = 0; h <= 24; h += 6)
        {
            var y = ChartHeight - (h * HourScale) + TopMargin;
            <line x1="@LeftMargin" y1="@y" x2="@(TotalWidth - RightMargin)" y2="@y" stroke="#e0e0e0" stroke-width="1" />
            <g>
                <text x="@(LeftMargin - 10)" y="@(y + 4)" font-size="12" text-anchor="end" fill="#666">@(h)h</text>
            </g>
        }

        <!-- Bars -->
        @for (int i = 0; i < Days.Count; i++)
        {
            var day = Days[i];
            // Since Days are mostRecentFirst, we reverse index or the list for the chart
            var displayIndex = Days.Count - 1 - i; 
            var x = LeftMargin + (displayIndex * BarSlotWidth) + (BarPadding / 2);
            
            var nightHeight = (day.Summary.NightSleepMinutes / 60.0) * HourScale;
            var napsHeight = (day.Summary.NapsMinutes / 60.0) * HourScale;
            
            var nightY = ChartHeight - nightHeight + TopMargin;
            var napsY = nightY - napsHeight;

            <!-- Night Sleep Stack -->
            <rect x="@x" y="@nightY" width="@BarWidth" height="@nightHeight" fill="#1a237e">
                <title>@day.Date: Night @FormatMinutes(day.Summary.NightSleepMinutes)</title>
            </rect>

            <!-- Naps Stack -->
            <rect x="@x" y="@napsY" width="@BarWidth" height="@napsHeight" fill="#ffb300">
                <title>@day.Date: Naps @FormatMinutes(day.Summary.NapsMinutes)</title>
            </rect>

            <!-- Date Label -->
            <g>
                <text x="@(x + BarWidth / 2)" y="@(TotalHeight - 5)" font-size="10" text-anchor="middle" fill="#999">@day.Date.ToString("dd.MM")</text>
            </g>
        }

        <!-- Legend -->
        <g transform="translate(@(TotalWidth - 150), 10)">
            <rect x="0" y="0" width="12" height="12" fill="#ffb300" />
            <text x="18" y="10" font-size="12" fill="#333">Naps</text>
            <rect x="0" y="20" width="12" height="12" fill="#1a237e" />
            <text x="18" y="30" font-size="12" fill="#333">Night</text>
        </g>
    </svg>
</div>

@code {
    [Parameter] public List<DailyRhythmMapDay> Days { get; set; } = new();

    private const double TotalWidth = 1000;
    private const double TotalHeight = 350;
    private const double TopMargin = 40;
    private const double BottomMargin = 30;
    private const double LeftMargin = 50;
    private const double RightMargin = 20;

    private const double ChartHeight = TotalHeight - TopMargin - BottomMargin;
    private const double HourScale = ChartHeight / 24.0;

    private double BarSlotWidth => (TotalWidth - LeftMargin - RightMargin) / Math.Max(1, Days.Count);
    private double BarPadding => BarSlotWidth * 0.3;
    private double BarWidth => BarSlotWidth - BarPadding;

    private string FormatMinutes(double totalMinutes)
    {
        var h = (int)(totalMinutes / 60);
        var m = (int)(totalMinutes % 60);
        return $"{h}h {m}m";
    }
}
